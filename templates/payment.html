<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasePark - Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
        }
        .price-tag {
            font-size: 2rem;
            color: #0d6efd;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card p-4">
                    <h3 class="text-center mb-4">Confirm Your Payment</h3>
                    <p><strong>Parking Lot:</strong> {{ lot_name }}</p>
                    <p><strong>Duration:</strong> {{ duration }} hours</p>
                    <hr>
                    <div class="text-center mb-3">
                        <span class="price-tag">â‚¹{{ amount }}</span>
                        <p class="text-muted">Total Payable Amount</p>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="payBtn" class="btn btn-primary btn-lg">Proceed to Pay</button>
                        <a href="javascript:history.back()" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Razorpay Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        document.getElementById('payBtn').onclick = function(e){
            var orderId = "{{ order_id }}";
            var successUrl = "{{ payment_success_url }}";
            var dashboardUrl = "{{ url_for('user.dashboard') }}";
            
            var options = {
                "key": "{{ key_id }}",
                "amount": "{{ amount_paise }}", 
                "currency": "INR",
                "name": "EasePark",
                "description": "Parking Payment",
                "image": "/static/images/logo.png",
                "order_id": orderId,
                "handler": function(response){
                    window.location.href = successUrl + "?payment_id=" + response.razorpay_payment_id +
                               "&order_id=" + orderId +
                               "&reservation_id={{ reservation.id }}";
                },
                "prefill": {
                    "name": "{{ user_name }}",
                    "email": "{{ user_email }}",
                    "contact": "{{ user_phone }}"
                },
                "theme": {
                    "color": "#0d6efd"
                },
                "modal": {
                    "ondismiss": function(){
                        // SCENARIO 2: USER CANCELS (closes popup)
                        window.location.href = dashboardUrl + "?payment=cancelled";
                    }
                }
            };
            var rzp = new Razorpay(options);

            rzp.on('payment.failed', function (response){
                // You can optionally log response.error.description for debugging
                // console.log(response.error.description); 
                window.location.href = dashboardUrl + "?payment=failed";
            });

            rzp.open();
            e.preventDefault();
        }
    </script>
</body>
</html>
