<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EasePark â€” Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --accent: #0d6efd;
      --muted: #6c757d;
      --card-bg: #ffffff;
      --page-bg: #f6f7fb;
    }

    body {
      background: var(--page-bg);
      color: #212529;
    }

    .navbar-brand img {
      height: 44px;
    }

    .profile-avatar {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid rgba(0, 0, 0, 0.06);
    }

    .action-btn {
      min-width: 170px;
    }

    .card-rounded {
      border-radius: 14px;
    }

    .small-muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .lot-pill {
      background: #f1f5fb;
      border-radius: 12px;
      padding: 6px 10px;
      display: inline-block;
      margin: 4px 4px 4px 0;
    }

    .no-select {
      user-select: none;
    }

    @media (max-width:767px) {
      .action-btn {
        width: 100%;
      }
    }
  </style>

</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm py-2">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('user.dashboard') }}">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="EasePark logo">
      </a>


      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>


      <div class="collapse navbar-collapse" id="navMain">
        <!-- Centered links -->
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link active" href="{{ url_for('user.dashboard') }}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('user.choose_booking') }}">Book Spot</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('user.booking_history') }}">My Bookings</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('user.user_summary') }}">Summary</a></li>
        </ul>


        <!-- User info and dropdown -->
        <div class="d-flex align-items-center gap-3">
          <div class="text-end d-none d-md-block">
            <div class="fw-semibold">{{ user.username }}</div>
            <div class="small-muted">{{ user.email }}</div>
          </div>


          <div class="dropdown">
            <button class="btn btn-outline-secondary d-flex align-items-center gap-2 dropdown-toggle" id="profileMenu"
              data-bs-toggle="dropdown" aria-expanded="false">
              <span class="d-none d-md-inline">Profile</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileMenu">
              <li><a class="dropdown-item" href="{{ url_for('user.user_profile_view') }}">View profile</a></li>
              <li><a class="dropdown-item" href="{{ url_for('user.user_profile_edit') }}">Edit profile</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- FLASHES -->
  <div class="container mt-4">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    {% for msg in messages %}
    <div class="alert alert-info d-flex align-items-center justify-content-between rounded-3">
      <div class="me-2">{{ msg }}</div>
      <button class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
  </div>

  <!-- MAIN -->
  <div class="container mt-3">
    <div class="row g-4">

      <!-- LEFT: Welcome + Actions -->
      <div class="col-lg-8">
        <div class="card card-rounded shadow-sm p-4">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h3 class="mb-0">Welcome back, <span class="text-primary">{{ user.username }}</span></h3>
              <div class="small-muted">Manage your parking quickly and easily</div>
            </div>

            <div class="d-flex gap-2 flex-wrap">
              <a href="{{ url_for('user.choose_booking') }}" class="btn btn-primary action-btn">ðŸš— Book a Spot</a>
              <a href="{{ url_for('user.booking_history') }}" class="btn btn-outline-secondary action-btn">ðŸ•’ My
                Bookings</a>
              <a href="{{ url_for('user.user_summary') }}" class="btn btn-outline-warning action-btn">ðŸ“Š Summary</a>
            </div>
          </div>

          <hr>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <h6 class="mb-2">Profile</h6>
                <div class="d-flex align-items-center gap-3">
                  <div>
                    <div class="fw-bold">{{ user.full_name if user.full_name else user.username }}</div>
                    <div class="small-muted">Member since: {{ user.member_since.date() }}</div>
                    <div class="small-muted">Total bookings: {{ user.total_bookings }}</div>
                  </div>
                </div>
              </div>

              <div>
                <h6 class="mb-2">Active Bookings</h6>
                {% if active_bookings %}
                <div class="list-group">
                  {% for booking in active_bookings %}
                  <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                    <div>
                      <div class="fw-bold">{{ booking.lot_name }}</div>
                      <div class="small-muted">Spot {{ booking.spot_number }} â€¢ {{ booking.date }}</div>
                    </div>
                    <div class="text-end small-muted no-select">{{ booking.time_range }}</div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="border rounded p-3 text-center small-muted">No active bookings. Book a spot to get started.
                </div>
                {% endif %}
              </div>
            </div>

            <div class="col-md-6">
              <h6 class="mb-2">Booking History</h6>
              <div class="card p-3 card-rounded shadow-sm" style="height:250px;">
                <canvas id="bookingHistoryChart" height="180"></canvas>
              </div>

              <div class="mt-3 small-muted">Tip: Release your spot when you're done to avoid extra charges.</div>
            </div>
          </div>

        </div>

        <!-- Available lots compressed for mobile under the main card -->
        <div class="mt-3 d-lg-none">
          <div class="card card-rounded p-3 shadow-sm">
            <h6>Parking lots near you</h6>
            {% for lot in available_lots %}
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <div>
                <div class="fw-semibold">{{ lot.name }}</div>
                <div class="small-muted">{{ lot.free_spots }} / {{ lot.total_spots }} available</div>
              </div>
              <div><a class="btn btn-sm btn-outline-primary" href="{{ url_for('user.choose_booking') }}">Reserve</a>
              </div>
            </div>
            {% else %}
            <div class="small-muted">No availability data.</div>
            {% endfor %}
          </div>
        </div>

      </div>

      <!-- RIGHT: Sidebar -->
      <div class="col-lg-4">

        <div class="card card-rounded p-3 shadow-sm mb-3">
          <h6 class="mb-2">Nearby Parking Lots</h6>
          {% for lot in available_lots %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="fw-semibold">{{ lot.name }}</div>
              <div class="small-muted">{{ lot.free_spots }} / {{ lot.total_spots }}</div>
            </div>
            <div>
              <span class="lot-pill">{{ lot.free_spots }} free</span>
            </div>
          </div>
          {% else %}
          <div class="small-muted">No availability data.</div>
          {% endfor %}

          <div class="mt-3 text-center">
            <a href="{{ url_for('user.choose_booking') }}" class="btn btn-sm btn-primary">Search nearby lots</a>
          </div>
        </div>

        <div class="card card-rounded p-3 shadow-sm mb-3">
          <h6 class="mb-2">Notifications</h6>
          {% for note in notifications %}
          <div class="border rounded p-2 mb-2 small-muted">{{ note }}</div>
          {% else %}
          <div class="small-muted">No new notifications.</div>
          {% endfor %}
        </div>

        <div class="card card-rounded p-3 shadow-sm">
          <h6 class="mb-2">Quick actions</h6>
          <div class="d-grid gap-2">
            <a class="btn btn-outline-success" href="{{ url_for('user.choose_booking') }}">Reserve spot</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('user.booking_history') }}">View history</a>
            <a class="btn btn-outline-warning" href="{{ url_for('user.user_profile_edit') }}">Edit profile</a>
          </div>
        </div>

      </div>

    </div>
  </div>


  <!-- SCRIPTS -->
  <script>
    // Chart.js â€” keep variable names stable to avoid collisions with other charts
    (function () {
      const labels = {{ chart_labels | tojson
    }} || [];
    const data = {{ chart_data | tojson }} || [];

    const ctx = document.getElementById('bookingHistoryChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Bookings',
            data: data,
            backgroundColor: 'rgba(13,110,253,0.08)',
            borderColor: 'rgba(13,110,253,0.9)',
            borderWidth: 1,
            hoverBackgroundColor: 'rgba(13,110,253,0.12)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }
    }) ();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"></script>
</body>

</html>